
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ù¾Ø®Ø´ Ù…ÙˆØ²ÛŒÚ© Ø¨Ø§ Ú©Ø§ÙˆØ± Ø¢Ù„Ø¨ÙˆÙ…</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/music-metadata-browser@2.5.2/lib/index.umd.min.js"></script>

  <style>
    body { font-family: Tahoma; direction: rtl; background-color: #f4f4f4; padding: 20px; }
    table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; vertical-align: middle; max-width: 150px; }
    .btn { background-color: #4caf50; color: white; padding: 6px 10px; border: none; margin: 2px; cursor: pointer; font-size: 12px; }
    .btn:disabled { background-color: #aaa; }
    .equalizer { width: 50px; height: 30px; display: flex; align-items: flex-end; gap: 3px; justify-content: center; }
    .bar { width: 4px; background: #4caf50; border-radius: 2px; animation: bounce 1s infinite ease-in-out; }
    .bar:nth-child(1) { animation-delay: 0s; }
    .bar:nth-child(2) { animation-delay: 0.1s; }
    .bar:nth-child(3) { animation-delay: 0.2s; }
    .bar:nth-child(4) { animation-delay: 0.3s; }
    .bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 100% { height: 20%; } 50% { height: 100%; } }
    .btn-delete { color: red; cursor: pointer; }
    img.cover-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
    audio { max-width: 160px; }
    progress { width: 100%; height: 20px; margin: 10px 0; cursor: pointer; direction: ltr !important; }
    .controls-top { margin: 15px 0; }
  </style>
</head>
<body>

<h2>Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾Ø®Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ</h2>

<input type="file" id="audioReplaceInput" multiple accept="audio/*" style="display:none;" />
<button class="btn" id="replaceBtn">ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ)</button>

<input type="file" id="audioAppendInput" multiple accept="audio/*" style="display:none;" />
<button class="btn" id="appendBtn">â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„</button>

<button class="btn" id="toggleRepeatBtn">ğŸ” ØªÚ©Ø±Ø§Ø±: Ø®Ø§Ù…ÙˆØ´</button>

<div class="controls-top">
  <button class="btn" id="prevBtn">â—€ï¸ Ù‚Ø¨Ù„ÛŒ</button>
  <button class="btn" id="nextBtn">â–¶ï¸ Ø¨Ø¹Ø¯ÛŒ</button>
</div>

<progress id="globalProgress" value="0" max="1"></progress>

<table id="audioTable">
  <thead>
    <tr>
      <th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th>
      <th>ÙØ±Ù…Øª</th>
      <th>Ø­Ø¬Ù… (MB)</th>
      <th>Ù…Ø¯Øª</th>
      <th>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</th>
      <th>Ú©Ø§ÙˆØ±</th>
      <th>Ù¾Ø®Ø´</th>
      <th>Ú©Ù†ØªØ±Ù„</th>
      <th>Ø§Ú©ÙˆØ§Ù„Ø§ÛŒØ²Ø±</th>
      <th>Ø­Ø°Ù</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let repeatEnabled = false;
let currentAudio = null;
let currentEq = null;
const progressBar = document.getElementById('globalProgress');

const table = $('#audioTable').DataTable({
  language: {
    search: "Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ:",
    lengthMenu: "Ù†Ù…Ø§ÛŒØ´ _MENU_ ÙØ§ÛŒÙ„",
    info: "Ù†Ù…Ø§ÛŒØ´ _START_ ØªØ§ _END_ Ø§Ø² _TOTAL_ ÙØ§ÛŒÙ„",
    paginate: { first: "Ø§ÙˆÙ„", last: "Ø¢Ø®Ø±", next: "Ø¨Ø¹Ø¯ÛŒ", previous: "Ù‚Ø¨Ù„ÛŒ" }
  }
});

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('toggleRepeatBtn').onclick = () => {
    repeatEnabled = !repeatEnabled;
    if (currentAudio) currentAudio.loop = repeatEnabled;
    document.getElementById('toggleRepeatBtn').textContent = repeatEnabled ? "ğŸ” ØªÚ©Ø±Ø§Ø±: Ø±ÙˆØ´Ù†" : "ğŸ” ØªÚ©Ø±Ø§Ø±: Ø®Ø§Ù…ÙˆØ´";
  };

  document.getElementById('replaceBtn').onclick = () => document.getElementById('audioReplaceInput').click();
  document.getElementById('appendBtn').onclick = () => document.getElementById('audioAppendInput').click();

  document.getElementById('audioReplaceInput').addEventListener('change', function () {
    table.clear().draw();
    currentAudio = null;
    progressBar.value = 0;
    Array.from(this.files).forEach(file => addFileToTable(file));
    this.value = '';
  });

  document.getElementById('audioAppendInput').addEventListener('change', function () {
    Array.from(this.files).forEach(file => addFileToTable(file));
    this.value = '';
  });

  document.getElementById('prevBtn').onclick = () => {
    if (!currentAudio) return;
    const rows = Array.from(table.rows().nodes());
    const index = rows.findIndex(row => row.querySelector('audio') === currentAudio);
    if (index > 0) {
      const prevAudio = rows[index - 1].querySelector('audio');
      if (prevAudio) {
        currentAudio.pause();
        prevAudio.currentTime = 0;
        prevAudio.play();
      }
    }
  };

  document.getElementById('nextBtn').onclick = () => {
    if (!currentAudio) return;
    const rows = Array.from(table.rows().nodes());
    const index = rows.findIndex(row => row.querySelector('audio') === currentAudio);
    if (index >= 0 && index < rows.length - 1) {
      const nextAudio = rows[index + 1].querySelector('audio');
      if (nextAudio) {
        currentAudio.pause();
        nextAudio.currentTime = 0;
        nextAudio.play();
      }
    }
  };
});

progressBar.addEventListener('click', function (e) {
  if (!currentAudio || !currentAudio.duration) return;
  const rect = this.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  currentAudio.currentTime = percent * currentAudio.duration;
});

function createEqualizer() {
  const eq = document.createElement('div');
  eq.className = 'equalizer';
  for (let i = 0; i < 5; i++) {
    const bar = document.createElement('div');
    bar.className = 'bar';
    eq.appendChild(bar);
  }
  eq.style.visibility = 'hidden';
  return eq;
}

async function extractCover(file) {
  try {
    const metadata = await musicMetadata.parseBlob(file);
    const pic = metadata.common.picture?.[0];
    if (pic) {
      const blob = new Blob([pic.data], { type: pic.format });
      return URL.createObjectURL(blob);
    }
  } catch (e) {
    console.warn("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§ÙˆØ±:", e);
  }
  return null;
}

function addFileToTable(file) {
  const url = URL.createObjectURL(file);
  const audioPlayer = document.createElement('audio');
  audioPlayer.src = url;
  audioPlayer.controls = true;

  const remainingTime = document.createElement('span');
  const equalizer = createEqualizer();
  const deleteBtn = document.createElement('span');
  deleteBtn.textContent = 'ğŸ—‘ï¸';
  deleteBtn.className = 'btn-delete';

  const btnBackward = document.createElement('button');
  btnBackward.className = 'btn';
  btnBackward.textContent = 'âª 10s';
  btnBackward.onclick = () => audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);

  const btnForward = document.createElement('button');
  btnForward.className = 'btn';
  btnForward.textContent = 'â© 10s';
  btnForward.onclick = () => audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);

  const controlContainer = document.createElement('div');
  controlContainer.append(btnBackward, btnForward);

  audioPlayer.addEventListener('play', () => {
    if (currentAudio && currentAudio !== audioPlayer) currentAudio.pause();
    currentAudio = audioPlayer;
    currentEq = equalizer;
    audioPlayer.loop = repeatEnabled;
    equalizer.style.visibility = "visible";
  });

  audioPlayer.addEventListener('pause', () => equalizer.style.visibility = "hidden");
  audioPlayer.addEventListener('timeupdate', () => {
    const remain = audioPlayer.duration - audioPlayer.currentTime;
    remainingTime.textContent = remain.toFixed(1);
    progressBar.value = audioPlayer.currentTime / audioPlayer.duration;
  });

  audioPlayer.addEventListener('ended', () => {
    progressBar.value = 0;
    equalizer.style.visibility = "hidden";
  });

  audioPlayer.addEventListener('loadedmetadata', () => {
    extractCover(file).then(coverUrl => {
      const row = table.row.add([
        file.name,
        '.' + file.name.split('.').pop(),
        (file.size / 1024 / 1024).toFixed(2),
        audioPlayer.duration.toFixed(1),
        '',
        `<img src="${coverUrl || 'https://via.placeholder.com/60?text=ğŸµ'}" class="cover-img" />`,
        '',
        '',
        '',
        ''
      ]).draw(false).node();

      row.cells[4].appendChild(remainingTime);
      row.cells[6].appendChild(audioPlayer);
      row.cells[7].appendChild(controlContainer);
      row.cells[8].appendChild(equalizer);
      row.cells[9].appendChild(deleteBtn);

      deleteBtn.onclick = () => {
        table.row(deleteBtn.closest('tr')).remove().draw(false);
        URL.revokeObjectURL(url);
      };
    });
  });
}
</script>

</body>
</html>
